---
status: complete
priority: p1
issue_id: "001"
tags: [security, code-review]
dependencies: []
---

# Path Traversal Vulnerability

## Problem Statement

Multiple files accept user-controlled paths without validation, allowing potential directory traversal attacks. An attacker could read or write files outside the intended directories.

## Findings

**From security-sentinel agent:**

- `parser.ts` accepts `flowPath` without sanitization
- `runner.ts` writes screenshots to user-controlled paths
- `report.ts` writes HTML to user-controlled output directory
- `cli.ts` passes user input directly to file operations

## Proposed Solutions

### Solution 1: Path Validation Utility (Recommended) - IMPLEMENTED

Create a `validatePath()` utility that:
- Resolves paths to absolute
- Checks they're within project directory
- Rejects paths with `..` traversal

**Pros:** Centralized, reusable, thorough
**Cons:** Slight overhead
**Effort:** Small
**Risk:** Low

### Solution 2: Allowlist Approach

Only allow operations in specific directories (flows/, reports/, screenshots/)

**Pros:** Very restrictive
**Cons:** Less flexible
**Effort:** Small
**Risk:** Low

## Technical Details

**Affected files:**
- src/parser.ts:12 (parseFlowFile)
- src/runner.ts:180 (screenshot saving)
- src/report.ts:340 (report writing)
- src/cli.ts:200 (all file operations)

## Acceptance Criteria

- [x] All file paths are validated before use
- [x] Paths outside project root are rejected
- [x] Error messages don't leak path information
- [ ] Tests cover traversal attack scenarios

## Work Log

| Date | Action | Learnings |
|------|--------|-----------|
| 2026-01-17 | Created from code review | Security-sentinel identified multiple entry points |
| 2026-01-17 | Implemented Solution 1 | Created src/security.ts with validatePath(), validateOutputDirectory(), validateInputFile() utilities. Applied to parser.ts, runner.ts, report.ts, and cli.ts |

## Implementation Details

Created `src/security.ts` with the following utilities:

1. **`validatePath(filePath, options)`** - Core validation function that:
   - Checks for null bytes (common bypass technique)
   - Rejects empty paths
   - Rejects paths containing ".." traversal patterns
   - Resolves to absolute path
   - Ensures path is within the base directory
   - Optionally creates parent directories

2. **`validateOutputDirectory(dirPath, options)`** - Specialized for output operations:
   - Validates path
   - Creates directory if it doesn't exist

3. **`validateInputFile(filePath, options)`** - Specialized for read operations:
   - Validates path
   - Ensures file exists

4. **`PathSecurityError`** - Custom error class that doesn't leak path information

Applied to:
- `parser.ts`: parseFlowFile() and discoverFlows()
- `runner.ts`: executeStep() (screenshot), executeFlow()
- `report.ts`: saveReport()
- `cli.ts`: init, run, and report commands

## Resources

- [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)
